name: CI/CD - Backend API Gateway

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/backend

jobs:
  build_and_push_backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies & Run Tests (Backend Gateway)
        run: |
          cd backend
          pip install -r requirements.txt
          python -m pytest tests/ -v --tb=short

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

---

## FILE STRUCTURE SUMMARY

Here's the complete list of all new/modified files:
```
quirk-ai-kiosk-main/
├── .github/workflows/
│   ├── ci-backend.yml          ← MODIFIED
│   └── ci-frontend.yml         ← MODIFIED
├── backend/
│   ├── pytest.ini              ← NEW
│   ├── requirements.txt        ← MODIFIED
│   ├── app/
│   │   ├── repositories/       ← NEW FOLDER
│   │   │   ├── __init__.py     ← NEW
│   │   │   ├── memory_repository.py  ← NEW
│   │   │   └── sqlite_repository.py  ← NEW
│   │   └── routers/
│   │       └── analytics.py    ← MODIFIED
│   └── tests/                  ← NEW FOLDER
│       ├── __init__.py         ← NEW
│       ├── test_inventory.py   ← NEW
│       ├── test_recommendations.py ← NEW
│       └── test_repositories.py    ← NEW
└── frontend/
    ├── package.json            ← MODIFIED
    └── src/
        ├── setupTests.js       ← NEW
        ├── __tests__/          ← NEW FOLDER
        │   ├── GuidedQuiz.test.js      ← NEW
        │   └── PaymentCalculator.test.js ← NEW
        ├── data/               ← NEW FOLDER
        │   ├── quizQuestions.js    ← NEW
        │   └── paymentOptions.js   ← NEW
        ├── hooks/              ← NEW FOLDER
        │   ├── index.js        ← NEW
        │   ├── useQuiz.js      ← NEW
        │   └── usePaymentCalc.js   ← NEW
        └── components/
            ├── quiz/           ← NEW FOLDER
            │   ├── index.js    ← NEW
            │   ├── QuestionCard.js     ← NEW
            │   ├── QuizProgress.js     ← NEW
            │   └── LeaseHelpModal.js   ← NEW
            └── calculator/     ← NEW FOLDER
                ├── index.js    ← NEW
                ├── LeaseCalculator.js  ← NEW
                └── FinanceCalculator.js ← NEW
